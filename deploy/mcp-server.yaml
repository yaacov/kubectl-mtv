# kubectl-mtv MCP Server — OpenShift Deployment
#
# Deploys the MCP server Deployment + Service in SSE mode on an OpenShift cluster.
# Lightspeed integration is handled separately (see deploy/olsconfig-patch.yaml).
#
# Quick start:
#   oc apply -f deploy/mcp-server.yaml          # deployment + service
#   oc patch olsconfig cluster --type merge \    # register with Lightspeed
#     -p "$(cat deploy/olsconfig-patch.yaml)"
#
# How authentication works:
#   The OLSConfig header uses valueFrom type "client", which makes
#   Lightspeed forward the logged-in UI user's token on every request.
#
#   1. User interacts with Lightspeed in the OpenShift console.
#   2. Lightspeed sends "Authorization: Bearer <user-token>" to the MCP server.
#   3. The MCP server extracts the token from the header.
#   4. kubectl-mtv is called with --server https://kubernetes.default.svc --token <user-token>.
#   5. The Kubernetes API authenticates and authorizes using that user's identity.
#
#   The deployment itself has NO RBAC bindings — permissions are entirely
#   determined by the UI user's own token. No shared credentials.
#
# HTTP:
#   The Service uses plain HTTP communication.
#   The Route provides TLS termination at the edge (ingress router).
#
# SSE endpoint: http://kubectl-mtv-mcp-server.openshift-mtv.svc:8080/sse
# ---

apiVersion: v1
kind: ServiceAccount
metadata:
  name: kubectl-mtv-mcp-server
  namespace: openshift-mtv
  labels:
    app.kubernetes.io/name: kubectl-mtv-mcp-server
    app.kubernetes.io/component: mcp-server
    app.kubernetes.io/part-of: kubectl-mtv

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kubectl-mtv-mcp-server
  namespace: openshift-mtv
  labels:
    app.kubernetes.io/name: kubectl-mtv-mcp-server
    app.kubernetes.io/component: mcp-server
    app.kubernetes.io/part-of: kubectl-mtv
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: kubectl-mtv-mcp-server
  template:
    metadata:
      labels:
        app.kubernetes.io/name: kubectl-mtv-mcp-server
        app.kubernetes.io/component: mcp-server
        app.kubernetes.io/part-of: kubectl-mtv
    spec:
      serviceAccountName: kubectl-mtv-mcp-server
      securityContext:
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: mcp-server
          image: quay.io/yaacov/kubectl-mtv-mcp-server:latest
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          env:
            - name: MCP_HOST
              value: "0.0.0.0"
            - name: MCP_PORT
              value: "8080"
            - name: MCP_OUTPUT_FORMAT
              value: "text"
            - name: MCP_MAX_RESPONSE_CHARS
              value: "0"
            - name: MCP_KUBE_INSECURE
              value: 'true'
            - name: MCP_KUBE_SERVER
              value: "https://kubernetes.default.svc"
            # Set to "true" to disable write operations (read-only mode)
            - name: MCP_READ_ONLY
              value: "false"

          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 256Mi
          readinessProbe:
            tcpSocket:
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            tcpSocket:
              port: http
            initialDelaySeconds: 10
            periodSeconds: 30
          volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: home
              mountPath: /home/mtv
      volumes:
        - name: tmp
          emptyDir: {}
        - name: home
          emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: kubectl-mtv-mcp-server
  namespace: openshift-mtv
  labels:
    app.kubernetes.io/name: kubectl-mtv-mcp-server
    app.kubernetes.io/component: mcp-server
    app.kubernetes.io/part-of: kubectl-mtv
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: kubectl-mtv-mcp-server
  ports:
    - name: http
      port: 8080
      targetPort: http
      protocol: TCP

